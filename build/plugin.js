"use strict";var B=require("limbo");function D(r){var e=Object.create(null);return r&&Object.keys(r).forEach(function(t){if(t!=="default"){var s=Object.getOwnPropertyDescriptor(r,t);Object.defineProperty(e,t,s.get?s:{enumerable:!0,get:function(){return r[t]}})}}),e.default=r,Object.freeze(e)}var y=D(B);const q=r=>{if(r instanceof Error)return r;if(typeof r=="object"&&r!==null)try{return new Error(JSON.stringify(r))}catch{}return new Error(r)};class M extends Error{}class h extends M{status;headers;error;code;param;type;request_id;constructor(e,t,s,n){super(`${h.makeMessage(e,t,s)}`),this.status=e,this.headers=n,this.request_id=n?.["x-request-id"],this.error=t;const o=t;this.code=o?.code,this.param=o?.param,this.type=o?.type}static makeMessage(e,t,s){const n=t?.message?typeof t.message=="string"?t.message:JSON.stringify(t.message):t?JSON.stringify(t):s;return e&&n?`${e} ${n}`:e?`${e} status code (no body)`:n||"(no status code or body)"}static generate(e,t,s,n){if(!e||!n)return new F({message:s,cause:q(t)});const o=t?.error;return e===400?new J(e,o,s,n):e===401?new $(e,o,s,n):e===403?new z(e,o,s,n):e===404?new H(e,o,s,n):e===409?new K(e,o,s,n):e===422?new Y(e,o,s,n):e===429?new V(e,o,s,n):e>=500?new W(e,o,s,n):new h(e,o,s,n)}}class F extends h{constructor({message:e,cause:t}){super(void 0,void 0,e||"Connection error.",void 0),t&&(this.cause=t)}}class J extends h{}class $ extends h{}class z extends h{}class H extends h{}class K extends h{}class Y extends h{}class V extends h{}class W extends h{}class S extends Error{response;request;options;constructor(e,t,s){const n=e.status||e.status===0?e.status:"",o=e.statusText||"",i=`${n} ${o}`.trim(),a=i?`status code ${i}`:"an unknown error";super(`Request failed with ${a}: ${t.method} ${t.url}`),this.name="HTTPError",this.response=e,this.request=t,this.options=s}}class O extends Error{request;constructor(e){super(`Request timed out: ${e.method} ${e.url}`),this.name="TimeoutError",this.request=e}}const I=(()=>{let r=!1,e=!1;const t=typeof globalThis.ReadableStream=="function",s=typeof globalThis.Request=="function";if(t&&s)try{e=new globalThis.Request("https://empty.invalid",{body:new globalThis.ReadableStream,method:"POST",get duplex(){return r=!0,"half"}}).headers.has("Content-Type")}catch(n){if(n instanceof Error&&n.message==="unsupported BodyInit type")return!1;throw n}return r&&!e})(),G=typeof globalThis.AbortController=="function",X=typeof globalThis.ReadableStream=="function",Q=typeof globalThis.FormData=="function",C=["get","post","put","patch","head","delete"],Z={json:"application/json",text:"text/*",formData:"multipart/form-data",arrayBuffer:"*/*",blob:"*/*"},R=2147483647,ee=new TextEncoder().encode("------WebKitFormBoundaryaxpyiPgbbPti10Rw").length,P=Symbol("stop"),te={json:!0,parseJson:!0,stringifyJson:!0,searchParams:!0,prefixUrl:!0,retry:!0,timeout:!0,hooks:!0,throwHttpErrors:!0,onDownloadProgress:!0,onUploadProgress:!0,fetch:!0},re={method:!0,headers:!0,body:!0,mode:!0,credentials:!0,cache:!0,redirect:!0,referrer:!0,referrerPolicy:!0,integrity:!0,keepalive:!0,signal:!0,window:!0,dispatcher:!0,duplex:!0,priority:!0},se=r=>{if(!r)return 0;if(r instanceof FormData){let e=0;for(const[t,s]of r)e+=ee,e+=new TextEncoder().encode(`Content-Disposition: form-data; name="${t}"`).length,e+=typeof s=="string"?new TextEncoder().encode(s).length:s.size;return e}if(r instanceof Blob)return r.size;if(r instanceof ArrayBuffer)return r.byteLength;if(typeof r=="string")return new TextEncoder().encode(r).length;if(r instanceof URLSearchParams)return new TextEncoder().encode(r.toString()).length;if("byteLength"in r)return r.byteLength;if(typeof r=="object"&&r!==null)try{const e=JSON.stringify(r);return new TextEncoder().encode(e).length}catch{return 0}return 0},ne=(r,e)=>{const t=Number(r.headers.get("content-length"))||0;let s=0;return r.status===204?(e&&e({percent:1,totalBytes:t,transferredBytes:s},new Uint8Array),new Response(null,{status:r.status,statusText:r.statusText,headers:r.headers})):new Response(new ReadableStream({async start(n){const o=r.body.getReader();e&&e({percent:0,transferredBytes:0,totalBytes:t},new Uint8Array);async function i(){const{done:a,value:c}=await o.read();if(a){n.close();return}if(e){s+=c.byteLength;const u=t===0?0:s/t;e({percent:u,transferredBytes:s,totalBytes:t},c)}n.enqueue(c),await i()}await i()}}),{status:r.status,statusText:r.statusText,headers:r.headers})},oe=(r,e)=>{const t=se(r.body);let s=0;return new Request(r,{duplex:"half",body:new ReadableStream({async start(n){const o=r.body instanceof ReadableStream?r.body.getReader():new Response("").body.getReader();async function i(){const{done:a,value:c}=await o.read();if(a){e&&e({percent:1,transferredBytes:s,totalBytes:Math.max(t,s)},new Uint8Array),n.close();return}s+=c.byteLength;let u=t===0?0:s/t;(t<s||u===1)&&(u=.99),e&&e({percent:Number(u.toFixed(2)),transferredBytes:s,totalBytes:t},c),n.enqueue(c),await i()}await i()}})})},d=r=>r!==null&&typeof r=="object",m=(...r)=>{for(const e of r)if((!d(e)||Array.isArray(e))&&e!==void 0)throw new TypeError("The `options` argument must be an object");return T({},...r)},j=(r={},e={})=>{const t=new globalThis.Headers(r),s=e instanceof globalThis.Headers,n=new globalThis.Headers(e);for(const[o,i]of n.entries())s&&i==="undefined"||i===void 0?t.delete(o):t.set(o,i);return t};function b(r,e,t){return Object.hasOwn(e,t)&&e[t]===void 0?[]:T(r[t]??[],e[t]??[])}const v=(r={},e={})=>({beforeRequest:b(r,e,"beforeRequest"),beforeRetry:b(r,e,"beforeRetry"),afterResponse:b(r,e,"afterResponse"),beforeError:b(r,e,"beforeError")}),T=(...r)=>{let e={},t={},s={};for(const n of r)if(Array.isArray(n))Array.isArray(e)||(e=[]),e=[...e,...n];else if(d(n)){for(let[o,i]of Object.entries(n))d(i)&&o in e&&(i=T(e[o],i)),e={...e,[o]:i};d(n.hooks)&&(s=v(s,n.hooks),e.hooks=s),d(n.headers)&&(t=j(t,n.headers),e.headers=t)}return e},ie=r=>C.includes(r)?r.toUpperCase():r,ae=["get","put","head","delete","options","trace"],ce=[408,413,429,500,502,503,504],ue=[413,429,503],U={limit:2,methods:ae,statusCodes:ce,afterStatusCodes:ue,maxRetryAfter:Number.POSITIVE_INFINITY,backoffLimit:Number.POSITIVE_INFINITY,delay:r=>.3*2**(r-1)*1e3},he=(r={})=>{if(typeof r=="number")return{...U,limit:r};if(r.methods&&!Array.isArray(r.methods))throw new Error("retry.methods must be an array");if(r.statusCodes&&!Array.isArray(r.statusCodes))throw new Error("retry.statusCodes must be an array");return{...U,...r}};async function fe(r,e,t,s){return new Promise((n,o)=>{const i=setTimeout(()=>{t&&t.abort(),o(new O(r))},s.timeout);s.fetch(r,e).then(n).catch(o).then(()=>{clearTimeout(i)})})}async function pe(r,{signal:e}){return new Promise((t,s)=>{e&&(e.throwIfAborted(),e.addEventListener("abort",n,{once:!0}));function n(){clearTimeout(o),s(e.reason)}const o=setTimeout(()=>{e?.removeEventListener("abort",n),t()},r)})}const le=(r,e)=>{const t={};for(const s in e)!(s in re)&&!(s in te)&&!(s in r)&&(t[s]=e[s]);return t};class g{static create(e,t){const s=new g(e,t),n=async()=>{if(typeof s._options.timeout=="number"&&s._options.timeout>R)throw new RangeError(`The \`timeout\` option cannot be greater than ${R}`);await Promise.resolve();let a=await s._fetch();for(const c of s._options.hooks.afterResponse){const u=await c(s.request,s._options,s._decorateResponse(a.clone()));u instanceof globalThis.Response&&(a=u)}if(s._decorateResponse(a),!a.ok&&s._options.throwHttpErrors){let c=new S(a,s.request,s._options);for(const u of s._options.hooks.beforeError)c=await u(c);throw c}if(s._options.onDownloadProgress){if(typeof s._options.onDownloadProgress!="function")throw new TypeError("The `onDownloadProgress` option must be a function");if(!X)throw new Error("Streams are not supported in your environment. `ReadableStream` is missing.");return ne(a.clone(),s._options.onDownloadProgress)}return a},i=(s._options.retry.methods.includes(s.request.method.toLowerCase())?s._retry(n):n()).finally(async()=>{s.request.bodyUsed||await s.request.body?.cancel()});for(const[a,c]of Object.entries(Z))i[a]=async()=>{s.request.headers.set("accept",s.request.headers.get("accept")||c);const u=await i;if(a==="json"){if(u.status===204||(await u.clone().arrayBuffer()).byteLength===0)return"";if(t.parseJson)return t.parseJson(await u.text())}return u[a]()};return i}request;abortController;_retryCount=0;_input;_options;constructor(e,t={}){if(this._input=e,this._options={...t,headers:j(this._input.headers,t.headers),hooks:v({beforeRequest:[],beforeRetry:[],beforeError:[],afterResponse:[]},t.hooks),method:ie(t.method??this._input.method??"GET"),prefixUrl:String(t.prefixUrl||""),retry:he(t.retry),throwHttpErrors:t.throwHttpErrors!==!1,timeout:t.timeout??1e4,fetch:t.fetch??globalThis.fetch.bind(globalThis)},typeof this._input!="string"&&!(this._input instanceof URL||this._input instanceof globalThis.Request))throw new TypeError("`input` must be a string, URL, or Request");if(this._options.prefixUrl&&typeof this._input=="string"){if(this._input.startsWith("/"))throw new Error("`input` must not begin with a slash when using `prefixUrl`");this._options.prefixUrl.endsWith("/")||(this._options.prefixUrl+="/"),this._input=this._options.prefixUrl+this._input}if(G){const s=this._options.signal??this._input.signal;this.abortController=new globalThis.AbortController,this._options.signal=s?AbortSignal.any([s,this.abortController.signal]):this.abortController.signal}if(I&&(this._options.duplex="half"),this._options.json!==void 0&&(this._options.body=this._options.stringifyJson?.(this._options.json)??JSON.stringify(this._options.json),this._options.headers.set("content-type",this._options.headers.get("content-type")??"application/json")),this.request=new globalThis.Request(this._input,this._options),this._options.searchParams){const n="?"+(typeof this._options.searchParams=="string"?this._options.searchParams.replace(/^\?/,""):new URLSearchParams(this._options.searchParams).toString()),o=this.request.url.replace(/(?:\?.*?)?(?=#|$)/,n);(Q&&this._options.body instanceof globalThis.FormData||this._options.body instanceof URLSearchParams)&&!(this._options.headers&&this._options.headers["content-type"])&&this.request.headers.delete("content-type"),this.request=new globalThis.Request(new globalThis.Request(o,{...this.request}),this._options)}if(this._options.onUploadProgress){if(typeof this._options.onUploadProgress!="function")throw new TypeError("The `onUploadProgress` option must be a function");if(!I)throw new Error("Request streams are not supported in your environment. The `duplex` option for `Request` is not available.");this.request.body&&(this.request=oe(this.request,this._options.onUploadProgress))}}_calculateRetryDelay(e){if(this._retryCount++,this._retryCount>this._options.retry.limit||e instanceof O)throw e;if(e instanceof S){if(!this._options.retry.statusCodes.includes(e.response.status))throw e;const s=e.response.headers.get("Retry-After")??e.response.headers.get("RateLimit-Reset")??e.response.headers.get("X-RateLimit-Reset")??e.response.headers.get("X-Rate-Limit-Reset");if(s&&this._options.retry.afterStatusCodes.includes(e.response.status)){let n=Number(s)*1e3;Number.isNaN(n)?n=Date.parse(s)-Date.now():n>=Date.parse("2024-01-01")&&(n-=Date.now());const o=this._options.retry.maxRetryAfter??n;return n<o?n:o}if(e.response.status===413)throw e}const t=this._options.retry.delay(this._retryCount);return Math.min(this._options.retry.backoffLimit,t)}_decorateResponse(e){return this._options.parseJson&&(e.json=async()=>this._options.parseJson(await e.text())),e}async _retry(e){try{return await e()}catch(t){const s=Math.min(this._calculateRetryDelay(t),R);if(this._retryCount<1)throw t;await pe(s,{signal:this._options.signal});for(const n of this._options.hooks.beforeRetry)if(await n({request:this.request,options:this._options,error:t,retryCount:this._retryCount})===P)return;return this._retry(e)}}async _fetch(){for(const s of this._options.hooks.beforeRequest){const n=await s(this.request,this._options);if(n instanceof Request){this.request=n;break}if(n instanceof Response)return n}const e=le(this.request,this._options),t=this.request;return this.request=t.clone(),this._options.timeout===!1?this._options.fetch(t,e):fe(t,e,this.abortController,this._options)}}/*! MIT License Â© Sindre Sorhus */const E=r=>{const e=(t,s)=>g.create(t,m(r,s));for(const t of C)e[t]=(s,n)=>g.create(s,m(r,n,{method:t}));return e.create=t=>E(m(t)),e.extend=t=>(typeof t=="function"&&(t=t(r??{})),E(m(r,t))),e.stop=P,e},de=E(),ye="https://api.openai.com/v1";function me(r){const{apiKey:e,baseUrl:t,organizationId:s,kyOptions:n={}}=r,{headers:o,hooks:i={},prefixUrl:a,retry:c,timeout:u,...f}=n;return i.beforeError||(i.beforeError=[]),i.beforeError.push(async l=>{const{response:p}=l;if(p){const w=p.status,x=be(p.headers);let _,A;if(p.body){const k=await p.clone().text().catch(N=>q(N).message);_=ge(k)?.error,A=_?void 0:k}return new h(w,_,A,x)}else return h.generate(void 0,l,void 0,void 0)}),de.extend({prefixUrl:t||a||ye,headers:{"User-Agent":"openai-fetch",...e&&{Authorization:`Bearer ${e}`},...s&&{"OpenAI-Organization":s},...o},retry:c??{delay:l=>{const w=we(-.3,.3);return(.3*Math.pow(l-1,2)+w)*1e3}},timeout:u??1e3*60*10,hooks:i,...f})}function be(r){try{return r?Symbol.iterator in r?Object.fromEntries(Array.from(r).map(e=>[...e])):{...r}:{}}catch{return{}}}function ge(r){try{return JSON.parse(r)}catch{return}}function we(r,e){return Math.random()*(e-r)+r}class _e{responseFactory;onchunk;onend;buffer;constructor(e){this.responseFactory=e,this.buffer=""}write(e){let n=new TextDecoder().decode(e).split(`
`);if(n.length===1){this.buffer+=n[0];return}this.buffer.length>0&&(n[0]=this.buffer+n[0],this.buffer="");const o=n[n.length-1];o&&o.length>0&&(this.buffer=n.pop()),n.map(i=>i.trim()).filter(i=>i.length>0).forEach(i=>{const a=i.indexOf(":");if(i.substring(0,a)!=="data")return;const u=i.substring(a+1).trim();if(u.length!==0){if(u==="[DONE]"){this.onend?.();return}try{const f=JSON.parse(u);this.onchunk?.(this.responseFactory(f))}catch(f){console.error("Failed parsing streamed JSON chunk",f)}}})}}class L{writable;readable;constructor(e){const t=new _e(e);this.writable=new WritableStream(t),this.readable=new ReadableStream({start(s){t.onchunk=n=>s.enqueue(n),t.onend=()=>s.close()}})}}class Re{api;constructor(e={}){const t=globalThis.process||{env:{}},s=e.apiKey||t.env.OPENAI_API_KEY,n=e.organizationId||t.env.OPENAI_ORG_ID;if(!s)throw new Error("Missing OpenAI API key. Please provide one in the config or set the OPENAI_API_KEY environment variable.");this.api=me({apiKey:s,baseUrl:e.baseUrl,organizationId:n,kyOptions:e.kyOptions})}getApi(e){return e?this.api.extend(e):this.api}async createChatCompletion(e,t){return await this.getApi(t).post("chat/completions",{json:e}).json()}async streamChatCompletion(e,t){return(await this.getApi(t).post("chat/completions",{json:{...e,stream:!0},onDownloadProgress:()=>{}})).body.pipeThrough(new L(o=>o))}async createCompletions(e,t){return await this.getApi(t).post("completions",{json:e}).json()}async streamCompletion(e,t){return(await this.getApi(t).post("completions",{json:{...e,stream:!0},onDownloadProgress:()=>{}})).body.pipeThrough(new L(o=>o))}async createEmbeddings(e,t){return await this.getApi(t).post("embeddings",{json:e}).json()}async createModeration(e,t){return await this.getApi(t).post("moderations",{json:e}).json()}async createSpeech(e,t){return await this.getApi(t).post("audio/speech",{json:e}).arrayBuffer()}}const Te=[{id:"o4-mini",name:"o4-mini",description:"Faster, more affordable reasoning model"}];var Ee={onActivate:async()=>{console.log("OpenAI plugin activated"),y.settings.register({id:"api_key",type:"text",label:"API Key",description:"Your OpenAI API key",placeholder:"sk-...",variant:"password"});for(const r of Te)y.models.registerLLM({id:r.id,name:r.name,description:r.description,generateText:async({promptBuilder:e,onChunk:t})=>{const s=y.settings.get("api_key");if(typeof s!="string")return y.notifications.show({type:"warning",message:"You must provide an API key to use OpenAI models"});const n=new Re({apiKey:s});console.log("making request");const o=(await n.streamChatCompletion({model:r.id,messages:e.getMessages()})).getReader();for(;;){const i=await o.read();if(i.done)break;const a=i.value;if(!a)return;const c=a.choices[0]?.delta.content;c&&t(c)}}})}};module.exports=Ee;
